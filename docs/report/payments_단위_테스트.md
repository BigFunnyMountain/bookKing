# Payments 서비스 단위 테스트
							
## 테스트 대상 상세		
Payment 서비스 V2							
							
## 테스트 시나리오 목적
실제 서비스 오픈시 사용할 분산락에서 로직이 문제가 없는지 확인							
							
## 가정 및 필요사항
단위 테스트기 때문에 레디스 조회시 값을 수동으로 정의							

## 테스트 시나리오 목록
| ID  | 테스트 이름                             | 전제조건                                                                          | 테스트 단계 요약                                                                                                           | 입력값                                                                                     | 기댓값                                                                                 | 성공 여부 |
|-----|------------------------------------------|-------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------|-----------|
| 1   | 없는 사용자                              | 존재하지 않는 사용자                                                               | `paymentV2()` 실행 → 사용자 조회                                                                                           | `paymentService.paymentV2(1L, 1L, 1L, 1L, PayType.KAKAO_PAY)`                             | `InvalidRequestException` + `ErrorMessage.USER_NOT_FOUND` 발생                         | ✅         |
| 2   | 레디스 페어락 실패                       | 사용자 존재, 락 시도 시 실패                                                       | `paymentV2()` 실행 → 사용자 조회 → Redis 락 실패                                                                           | 동일 입력값                                                                               | `ServerException` + `ErrorMessage.REDIS_ERROR` 발생                                     | ✅         |
| 3   | 단독 구매 성공                           | 사용자 존재, 락 성공, 책 존재                                                      | `paymentV2()` 실행 → 사용자 & Redis 확인 → 책 권수 수정 → 주문 내역 생성                                                  | 동일 입력값                                                                               | `bookRepository.save` 1회, `createOrder()` 1회, 남은 책 권수 0                         | ✅         |
| 4   | 단독 구매 실패 - 존재하지 않는 책        | 사용자 존재, 락 성공                                                               | `paymentV2()` 실행 → 사용자 & Redis 확인 → 책 조회 실패                                                                   | 동일 입력값                                                                               | `NotFoundException` + `ErrorMessage.BOOK_NOT_FOUND` 발생                               | ✅         |
| 5   | 단독 구매 실패 - 책 권수 없음            | 사용자 존재, 락 성공, 책 존재                                                      | `paymentV2()` 실행 → 사용자 & Redis 확인 → 책 재고 확인                                                                   | 동일 입력값                                                                               | `InvalidRequestException` + `ErrorMessage.ZERO_BOOK_STOCK` 발생                        | ✅         |
| 6   | 단독 구매 실패 - 사용자의 돈 부족        | 사용자 존재, 락 성공, 책 존재, 재고 충분                                           | `paymentV2()` 실행 → 사용자 & Redis 확인 → 금액 비교 실패                                                                 | 동일 입력값                                                                               | `InvalidRequestException` + `ErrorMessage.SHORT_ON_MONEY` 발생                         | ✅         |
| 7   | 단독 환불 성공                           | 사용자 존재, 락 성공, 책 존재, 주문 존재, 한 권 환불, 기존 재고 99권               | `returnPayment()` 실행 → 사용자 및 주문자 비교 → 책 조회 → 상태 변경 및 환불                                             | `paymentService.returnPayment(user.getId(), order.getId())`                              | 재고 100권, 환불 금액 15,000원, 주문 ID 일치                                            | ✅         |
| 8   | 환불 실패 - 주문의 유저와 일치하지 않음  | 사용자 존재, 주문 존재                                                              | `returnPayment()` 실행 → 사용자 ≠ 주문자 → 예외 발생                                                                      | 동일 입력값                                                                               | `InvalidRequestException` + `ErrorMessage.NO_AUTHORITY_TO_RETURN_A_PAYMENT` 발생       | ✅         |
| 9   | 환불 실패 - 책 조회 실패                 | 사용자 존재, 주문 존재                                                              | `returnPayment()` 실행 → 사용자 확인 → 주문자 확인 → 책 조회 실패                                                        | 동일 입력값                                                                               | `NotFoundException` + `ErrorMessage.BOOK_NOT_FOUND` 발생                               | ✅         |
