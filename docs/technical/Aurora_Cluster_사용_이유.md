## 배경


V2 아키텍처에서는 리소스의 범위를 오로지 리소스 사용 비용으로 두었었다. 그 결과 실제로 비용 절감은 확실했지만 해당 아키텍처로 서비스를 실제 배포했다면 시간이 지날수록 관리에 드는 시간과 비용이 많아졌을 것이다.

위와 같은 이유로 V3 아키텍처를 구상하면서 중점으로 둔 것은 `리소스에 대한 범위를 어떻게 잡을 것인지` 그리고 `서비스의 고가용성 제공`이었다.

## 문제


**클러스터 구조가 아니면 장애 조치가 원활히 이뤄지지 않는다**


원래는 클러스터 구조를 사용할 생각이 없었다. 단순히 DB 인스턴스를 하나 만들고, 읽기 전용 복제본을 통해 장애 조치 및 트랜잭션 옵션(read-only)에 따른 트래픽 분산을 하려고 했지만 이와 같은 방법으로는 트래픽은 분산시킬 순 있어도 원활한 장애 조치를 할 수 없었다.

1. 장애 발생 시 직접 writer와 reader의 데이터베이스 엔드포인트를 바꿔줘야 한다.
2. AWS RDS 콘솔에서 직접 reader를 승격시켜 줘야 한다.

## 결정 및 이유


AWS RDS에서 DB(MySQL) 클러스터 구성 시 사용할 수 있는 옵션은 다음과 같았다.

![image](https://github.com/user-attachments/assets/25af5b23-2ee6-4e5e-9ea1-7c2b685ff228)

1. MySQL 엔진
    1. 프로덕션 또는 개발/테스트 선택
    2. 다중 AZ DB 클러스터 배포 선택
2. Aurora (MySQL Compatible)
    1. 프로덕션 또는 개발/테스트 선택
    2. 다중 AZ DB 클러스터 배포 선택

> 이때 예상했던 것과는 다르게 갑자기 클러스터를 사용하게 되면서 비용이 엄청나게 많이 나올 것으로 예상이 되어서 해당 서비스를 사용하되, 나머지 항목에 대해선 가격에 초점을 두었다.
> 

| 엔진 | 템플릿 | 가용성 및 내구성 | 클러스터 스토리지 구성 | 인스턴스 구성 | 할당된 스토리지 | 예상 비용(단위: USD) |
| --- | --- | --- | --- | --- | --- | --- |
| MySQL | 개발/테스트 | 다중 AZ DB 클러스터 | - | 스탠다드 클래스
db.m5d.large | 범용 SSD(gp3)
20 GiB | 594.78 |
| Aurora | 개발 테스트 | 다중 AZ DB 클러스터 | Aurora Standard | 버스터블 클래스
db.t3.medium | - | 91.25 |
| Aurora | 개발 테스트 | 다중 AZ DB 클러스터 | Aurora Standard | 서버리스 v2
1 ACU ~ 2ACU | - | 가변 요소라서 정확하지 않음 |

서버리스로 만들었을 때 ACU를 0.5 ~ 1.0 사이로 맞춰놓으면 적당히 성능과 비용을 모두 갖춘 상태로 사용할 수 있지만 성능 테스트를 어디서 돌릴 것인지 확실히 정해지지 않았기 때문에 비용을 예상하기 힘든 서버리스를 사용하는 리스크를 감수하기 보단 고정 가격이 정해져 있고, 데이터 전송 비용도 백만 건당 0.24 달러로 나름 합리적인 두 번째로 선택해서 적용했다.

## 결론



1. 일반 DB 인스턴스 사용 시 장애 조치를 원활하게 진행할 수 없어서 클러스터 구조를 선택함
2. 예상치 못한 비용 증가로 비용에 대한 것을 1순위로 보기로 정함
3. 최저 비용 자체는 Aurora 서버리스를 사용하는 것이 가장 비용 효율적이지만 비용 예측이 힘들기 때문에 그 다음으로 저렴한 Aurora 버스터블(db.t3.medium)을 사용하기로 정함
